---
# tasks file for IaC/k8s/tf/roles/k8s cilium
- name: Download and Install Cilium Helm Repos√≠tory
  block:
    - name: Add Stable Cilium Helm Repo
      kubernetes.core.helm_repository:
        repo_url: "{{ cilium.helm.repo_url }}"
        name: "{{ ciliumHelmChartName | default('cilium') }}"
        kubeconfig: "{{ kubeConfigDestination | default('~/.kube/config') }}"

    - name: Prepare Helm template file for Cilium
      ansible.builtin.template:
        dest: "{{ role_path }}/files/cilium.yaml"
        src: "{{ role_path }}/templates/cilium.yaml.j2"

    - name: Deploy Latest Version of Cilium
      kubernetes.core.helm:
        name: "{{ cilium.helm.name }}"
        chart_version: "{{ cilium.helm.chart_version }}"
        values_files: "{{ role_path }}/files/cilium.yaml"
        create_namespace: "{{ cilium.helm.create_namespace }}"
        chart_ref: "{{ ciliumHelmChartRef | default('cilium/cilium') }}"
        kubeconfig: "{{ kubeConfigDestination | default('~/.kube/config') }}"
        release_namespace: "{{ ciliumReleaseNamespace | default('kube-system') }}"

    - name: Remove Helm file for Cilium (delete file)
      ansible.builtin.file:
        state: absent
        path: "{{ role_path }}/files/cilium.yaml"
  connection: local
  delegate_to: localhost
